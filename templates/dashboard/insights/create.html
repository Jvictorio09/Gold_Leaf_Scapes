{% extends 'dashboard/base.html' %}

{% block title %}Create New Blog Post - Dashboard{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Create New Blog Post</h1>
            <p class="text-gray-600 mt-1">Write and publish your next article</p>
        </div>
        <a href="{% url 'dashboard_insights_list' %}" class="text-blue-600 hover:text-blue-800 font-medium">
            <i class="fas fa-arrow-left mr-2"></i>Back to Posts
        </a>
    </div>
</div>

<div class="bg-white rounded-lg shadow-lg p-6">
    <form method="post" id="blogForm" class="space-y-6">
        {% csrf_token %}
        
        <!-- Title -->
        <div>
            <label for="title" class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-heading mr-2 text-blue-500"></i>Title <span class="text-red-500">*</span>
            </label>
            <input type="text" name="title" id="title" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                   placeholder="Enter a compelling title for your blog post"
                   oninput="updateSlug()">
            <p class="text-xs text-gray-500 mt-1">A great title captures attention and improves SEO</p>
        </div>

        <!-- Slug -->
        <div>
            <label for="slug" class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-link mr-2 text-purple-500"></i>URL Slug
            </label>
            <input type="text" name="slug" id="slug"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                   placeholder="auto-generated-from-title">
            <p class="text-xs text-gray-500 mt-1">Leave empty to auto-generate from title. Use lowercase letters, numbers, and hyphens only.</p>
        </div>

        <!-- Featured Image -->
        <div>
            <label for="featured_image_url" class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-image mr-2 text-green-500"></i>Featured Image URL
            </label>
            <div class="flex gap-3">
                <input type="url" name="featured_image_url" id="featured_image_url"
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                       placeholder="https://res.cloudinary.com/...">
                <a href="{% url 'dashboard_gallery' %}" target="_blank" 
                   class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors whitespace-nowrap">
                    <i class="fas fa-images mr-2"></i>Browse Gallery
                </a>
            </div>
            <p class="text-xs text-gray-500 mt-1">Upload images via Gallery and paste the URL here. Recommended: 1200x630px</p>
            <div id="imagePreview" class="mt-3 hidden">
                <img id="previewImg" src="" alt="Preview" class="max-w-md rounded-lg shadow-md">
            </div>
        </div>

        <!-- Excerpt -->
        <div>
            <label for="excerpt" class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-align-left mr-2 text-orange-500"></i>Excerpt / Summary
            </label>
            <textarea name="excerpt" id="excerpt" rows="3"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all resize-none"
                      placeholder="Write a brief summary that will appear in blog listings and search results..."></textarea>
            <p class="text-xs text-gray-500 mt-1">A compelling excerpt increases click-through rates. Aim for 150-200 characters.</p>
            <div class="mt-1 text-xs text-gray-400">
                <span id="excerptCount">0</span> characters
            </div>
        </div>

        <!-- Content Editor -->
        <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-edit mr-2 text-indigo-500"></i>Content <span class="text-red-500">*</span>
            </label>
            <div id="editor" style="min-height: 400px;" class="border border-gray-300 rounded-lg"></div>
            <textarea name="content" id="content" style="display: none;"></textarea>
            <p class="text-xs text-gray-500 mt-1">Write your blog post content. You can use HTML formatting or plain text.</p>
        </div>

        <!-- Status and Publishing -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="status" class="block text-gray-700 text-sm font-bold mb-2">
                    <i class="fas fa-toggle-on mr-2 text-yellow-500"></i>Status
                </label>
                <select name="status" id="status"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all">
                    <option value="draft">Draft</option>
                    <option value="published">Published</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Save as draft to continue editing later</p>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>Post Information
                </label>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <p class="text-xs text-gray-600">
                        <i class="fas fa-user mr-1"></i><strong>Author:</strong> {{ request.user.get_full_name|default:request.user.username }}
                    </p>
                    <p class="text-xs text-gray-600 mt-1">
                        <i class="fas fa-calendar mr-1"></i><strong>Created:</strong> <span id="currentDate"></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200">
            <button type="submit" 
                    class="flex-1 md:flex-none px-8 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105">
                <i class="fas fa-save mr-2"></i>Save Post
            </button>
            <button type="button" onclick="saveDraft()" 
                    class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">
                <i class="fas fa-file-alt mr-2"></i>Save as Draft
            </button>
            <a href="{% url 'dashboard_insights_list' %}" 
               class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition-colors">
                <i class="fas fa-times mr-2"></i>Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // Initialize Quill Editor
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                ['link', 'image'],
                ['blockquote', 'code-block'],
                ['clean']
            ]
        },
        placeholder: 'Start writing your blog post...'
    });

    // Update content field before form submission
    document.getElementById('blogForm').addEventListener('submit', function(e) {
        const content = quill.root.innerHTML;
        document.getElementById('content').value = content;
    });

    // Auto-generate slug from title
    function updateSlug() {
        const title = document.getElementById('title').value;
        const slug = title.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '');
        document.getElementById('slug').value = slug;
    }

    // Save as draft
    function saveDraft() {
        document.getElementById('status').value = 'draft';
        const content = quill.root.innerHTML;
        document.getElementById('content').value = content;
        document.getElementById('blogForm').submit();
    }

    // Image preview
    document.getElementById('featured_image_url').addEventListener('input', function(e) {
        const url = e.target.value;
        const preview = document.getElementById('imagePreview');
        const img = document.getElementById('previewImg');
        
        if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
            img.src = url;
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    });

    // Excerpt character counter
    document.getElementById('excerpt').addEventListener('input', function(e) {
        document.getElementById('excerptCount').textContent = e.target.value.length;
    });

    // Set current date
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
</script>
{% endblock %}
