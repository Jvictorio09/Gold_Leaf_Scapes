{% extends 'dashboard/base.html' %}

{% block title %}Edit Blog Post - Dashboard{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Edit Blog Post</h1>
            <p class="text-gray-600 mt-1">Update and refine your article</p>
        </div>
        <div class="flex gap-3">
            {% if insight.status == 'published' %}
            <a href="{{ insight.get_absolute_url }}" target="_blank" 
               class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition-colors">
                <i class="fas fa-external-link-alt mr-2"></i>View Live
            </a>
            {% endif %}
            <a href="{% url 'dashboard_insights_list' %}" class="text-blue-600 hover:text-blue-800 font-medium">
                <i class="fas fa-arrow-left mr-2"></i>Back to Posts
            </a>
        </div>
    </div>
</div>

<div class="bg-white rounded-lg shadow-lg p-6">
    <form method="post" id="blogForm" class="space-y-6">
        {% csrf_token %}
        
        <!-- Status Badge -->
        <div class="mb-4 p-4 rounded-lg {% if insight.status == 'published' %}bg-green-50 border border-green-200{% else %}bg-yellow-50 border border-yellow-200{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold {% if insight.status == 'published' %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        <i class="fas fa-{% if insight.status == 'published' %}check-circle{% else %}edit{% endif %} mr-2"></i>
                        {{ insight.get_status_display }}
                    </span>
                    {% if insight.published_at %}
                    <p class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-calendar-check mr-1"></i>Published on {{ insight.published_at|date:"F d, Y" }} at {{ insight.published_at|date:"g:i A" }}
                    </p>
                    {% endif %}
                </div>
                <div class="text-sm text-gray-600">
                    <p><i class="fas fa-clock mr-1"></i>Last updated: {{ insight.updated_at|date:"M d, Y g:i A" }}</p>
                </div>
            </div>
        </div>

        <!-- Title -->
        <div>
            <label for="title" class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-heading mr-2 text-blue-500"></i>Title <span class="text-red-500">*</span>
            </label>
            <input type="text" name="title" id="title" value="{{ insight.title }}" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                   placeholder="Enter a compelling title for your blog post"
                   oninput="updateSlug()">
            <p class="text-xs text-gray-500 mt-1">A great title captures attention and improves SEO</p>
        </div>

        <!-- Slug -->
        <div>
            <label for="slug" class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-link mr-2 text-purple-500"></i>URL Slug
            </label>
            <input type="text" name="slug" id="slug" value="{{ insight.slug }}"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                   placeholder="auto-generated-from-title">
            <p class="text-xs text-gray-500 mt-1">Leave empty to auto-generate from title. Use lowercase letters, numbers, and hyphens only.</p>
            {% if insight.slug %}
            <p class="text-xs text-blue-600 mt-1">
                <i class="fas fa-info-circle mr-1"></i>Current URL: <a href="{{ insight.get_absolute_url }}" target="_blank" class="underline">{{ insight.get_absolute_url }}</a>
            </p>
            {% endif %}
        </div>

        <!-- Featured Image -->
        <div>
            <label for="featured_image_url" class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-image mr-2 text-green-500"></i>Featured Image URL
            </label>
            <div class="flex gap-3">
                <input type="url" name="featured_image_url" id="featured_image_url" value="{{ insight.featured_image_url }}"
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                       placeholder="https://res.cloudinary.com/...">
                <a href="{% url 'dashboard_gallery' %}" target="_blank" 
                   class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors whitespace-nowrap">
                    <i class="fas fa-images mr-2"></i>Browse Gallery
                </a>
            </div>
            <p class="text-xs text-gray-500 mt-1">Upload images via Gallery and paste the URL here. Recommended: 1200x630px</p>
            <div id="imagePreview" class="mt-3 {% if insight.featured_image_url %}block{% else %}hidden{% endif %}">
                <img id="previewImg" src="{% if insight.featured_image_url %}{{ insight.featured_image_url }}{% endif %}" alt="Preview" class="max-w-md rounded-lg shadow-md">
            </div>
        </div>

        <!-- Excerpt -->
        <div>
            <label for="excerpt" class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-align-left mr-2 text-orange-500"></i>Excerpt / Summary
            </label>
            <textarea name="excerpt" id="excerpt" rows="3"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all resize-none"
                      placeholder="Write a brief summary that will appear in blog listings and search results...">{{ insight.excerpt }}</textarea>
            <p class="text-xs text-gray-500 mt-1">A compelling excerpt increases click-through rates. Aim for 150-200 characters.</p>
            <div class="mt-1 text-xs text-gray-400">
                <span id="excerptCount">{{ insight.excerpt|length }}</span> characters
            </div>
        </div>

        <!-- Content Editor -->
        <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">
                <i class="fas fa-edit mr-2 text-indigo-500"></i>Content <span class="text-red-500">*</span>
            </label>
            <div id="editor" style="min-height: 400px;" class="border border-gray-300 rounded-lg"></div>
            <textarea name="content" id="content" style="display: none;">{{ insight.content }}</textarea>
            <p class="text-xs text-gray-500 mt-1">Write your blog post content. You can use HTML formatting or plain text.</p>
        </div>

        <!-- Status and Publishing -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="status" class="block text-gray-700 text-sm font-bold mb-2">
                    <i class="fas fa-toggle-on mr-2 text-yellow-500"></i>Status
                </label>
                <select name="status" id="status"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all">
                    <option value="draft" {% if insight.status == 'draft' %}selected{% endif %}>Draft</option>
                    <option value="published" {% if insight.status == 'published' %}selected{% endif %}>Published</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Change status to publish or save as draft</p>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>Post Information
                </label>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <p class="text-xs text-gray-600">
                        <i class="fas fa-user mr-1"></i><strong>Author:</strong> {{ insight.author.get_full_name|default:insight.author.username|default:"Gold Leaf Scapes" }}
                    </p>
                    <p class="text-xs text-gray-600 mt-1">
                        <i class="fas fa-calendar-plus mr-1"></i><strong>Created:</strong> {{ insight.created_at|date:"F d, Y g:i A" }}
                    </p>
                    <p class="text-xs text-gray-600 mt-1">
                        <i class="fas fa-calendar-edit mr-1"></i><strong>Last Updated:</strong> {{ insight.updated_at|date:"F d, Y g:i A" }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200">
            <button type="submit" 
                    class="flex-1 md:flex-none px-8 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105">
                <i class="fas fa-save mr-2"></i>Save Changes
            </button>
            <button type="button" onclick="saveDraft()" 
                    class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">
                <i class="fas fa-file-alt mr-2"></i>Save as Draft
            </button>
            {% if insight.status == 'published' %}
            <a href="{{ insight.get_absolute_url }}" target="_blank" 
               class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition-colors">
                <i class="fas fa-external-link-alt mr-2"></i>View Live
            </a>
            {% endif %}
            <a href="{% url 'dashboard_insights_list' %}" 
               class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition-colors">
                <i class="fas fa-times mr-2"></i>Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // Initialize Quill Editor with existing content
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                ['link', 'image'],
                ['blockquote', 'code-block'],
                ['clean']
            ]
        },
        placeholder: 'Start writing your blog post...'
    });

    // Load existing content
    const existingContent = document.getElementById('content').value;
    if (existingContent) {
        try {
            // Try to parse as JSON (Editor.js format)
            const jsonContent = JSON.parse(existingContent);
            if (jsonContent.blocks) {
                // If it's Editor.js JSON, convert to HTML
                let html = '';
                jsonContent.blocks.forEach(block => {
                    if (block.type === 'paragraph') {
                        html += '<p>' + (block.data.text || '') + '</p>';
                    } else if (block.type === 'header') {
                        html += `<h${block.data.level}>${block.data.text || ''}</h${block.data.level}>`;
                    } else if (block.type === 'list') {
                        const tag = block.data.style === 'ordered' ? 'ol' : 'ul';
                        html += `<${tag}><li>${block.data.items.join('</li><li>')}</li></${tag}>`;
                    }
                });
                quill.root.innerHTML = html;
            } else {
                quill.root.innerHTML = existingContent;
            }
        } catch (e) {
            // If not JSON, treat as HTML
            quill.root.innerHTML = existingContent;
        }
    }

    // Update content field before form submission
    document.getElementById('blogForm').addEventListener('submit', function(e) {
        const content = quill.root.innerHTML;
        document.getElementById('content').value = content;
    });

    // Auto-generate slug from title
    function updateSlug() {
        const title = document.getElementById('title').value;
        const slug = title.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '');
        const currentSlug = document.getElementById('slug').value;
        if (!currentSlug) {
            document.getElementById('slug').value = slug;
        }
    }

    // Save as draft
    function saveDraft() {
        document.getElementById('status').value = 'draft';
        const content = quill.root.innerHTML;
        document.getElementById('content').value = content;
        document.getElementById('blogForm').submit();
    }

    // Image preview
    document.getElementById('featured_image_url').addEventListener('input', function(e) {
        const url = e.target.value;
        const preview = document.getElementById('imagePreview');
        const img = document.getElementById('previewImg');
        
        if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
            img.src = url;
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    });

    // Excerpt character counter
    document.getElementById('excerpt').addEventListener('input', function(e) {
        document.getElementById('excerptCount').textContent = e.target.value.length;
    });
</script>
{% endblock %}
